var be=t=>{throw TypeError(t)};var te=(t,e,s)=>e.has(t)||be("Cannot "+s);var r=(t,e,s)=>(te(t,e,"read from private field"),s?s.call(t):e.get(t)),S=(t,e,s)=>e.has(t)?be("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),m=(t,e,s,i)=>(te(t,e,"write to private field"),i?i.call(t,s):e.set(t,s),s),x=(t,e,s)=>(te(t,e,"access private method"),s);import{J as Be,K as We,r as C,M as ze,t as $e,j as a,q as H,h as He,f as Ie,v as Ve,p as we,e as Le,k as Ke,l as Ze,o as qe,N as Ge,O as U,Q as ae,U as J,V as Je,W as xe,X as ye,Y as Xe,Z as Ye,$ as et,a0 as Ce,a1 as Ue,a2 as tt,S as B,T as Z,B as me,b as st}from"./index-nORPXnHn.js";import{s as rt,d as Fe,u as it,c as at,a as se,b as nt,o as ot,F as re}from"./delay-B36pBFVw.js";import{a as X,u as lt,F as q,b as G,I as ie,C as ct}from"./userStore-DSUL5nZ6.js";import{V as pe}from"./chunk-NTCQBYKE-DSbqkiIr.js";import{T as ht}from"./chunk-4IH3O7BJ-6lojFmKG.js";import{H as Se}from"./chunk-7OLJDQMT-P7D-RYa4.js";function ut(t){const{theme:e}=Be(),s=We();return C.useMemo(()=>ze(e.direction,{...s,...t}),[t,e.direction,s])}var[dt,ft]=$e({name:"AvatarStylesContext",hookName:"useAvatarStyles",providerName:"<Avatar/>"});function mt(t){var e;const s=t.split(" "),i=(e=s[0])!=null?e:"",u=s.length>1?s[s.length-1]:"";return i&&u?`${i.charAt(0)}${u.charAt(0)}`:i.charAt(0)}function _e(t){const{name:e,getInitials:s,...i}=t,u=ft();return a.jsx(H.div,{role:"img","aria-label":e,...i,__css:u.label,children:e?s==null?void 0:s(e):null})}_e.displayName="AvatarName";var Ae=t=>a.jsxs(H.svg,{viewBox:"0 0 128 128",color:"#fff",width:"100%",height:"100%",className:"chakra-avatar__svg",...t,children:[a.jsx("path",{fill:"currentColor",d:"M103,102.1388 C93.094,111.92 79.3504,118 64.1638,118 C48.8056,118 34.9294,111.768 25,101.7892 L25,95.2 C25,86.8096 31.981,80 40.6,80 L87.4,80 C96.019,80 103,86.8096 103,95.2 L103,102.1388 Z"}),a.jsx("path",{fill:"currentColor",d:"M63.9961647,24 C51.2938136,24 41,34.2938136 41,46.9961647 C41,59.7061864 51.2938136,70 63.9961647,70 C76.6985159,70 87,59.7061864 87,46.9961647 C87,34.2938136 76.6985159,24 63.9961647,24"})]});function pt(t){const{loading:e,src:s,srcSet:i,onLoad:u,onError:c,crossOrigin:o,sizes:l,ignoreFallback:p}=t,[g,v]=C.useState("pending");C.useEffect(()=>{v(s?"loading":"pending")},[s]);const n=C.useRef(),y=C.useCallback(()=>{if(!s)return;f();const b=new Image;b.src=s,o&&(b.crossOrigin=o),i&&(b.srcset=i),l&&(b.sizes=l),e&&(b.loading=e),b.onload=R=>{f(),v("loaded"),u==null||u(R)},b.onerror=R=>{f(),v("failed"),c==null||c(R)},n.current=b},[s,o,i,l,u,c,e]),f=()=>{n.current&&(n.current.onload=null,n.current.onerror=null,n.current=null)};return He(()=>{if(!p)return g==="loading"&&y(),()=>{f()}},[g,y,p]),p?"loaded":g}function Te(t){const{src:e,srcSet:s,onError:i,onLoad:u,getInitials:c,name:o,borderRadius:l,loading:p,iconLabel:g,icon:v=a.jsx(Ae,{}),ignoreFallback:n,referrerPolicy:y,crossOrigin:f}=t,R=pt({src:e,onError:i,crossOrigin:f,ignoreFallback:n})==="loaded";return!e||!R?o?a.jsx(_e,{className:"chakra-avatar__initials",getInitials:c,name:o}):C.cloneElement(v,{role:"img","aria-label":g}):a.jsx(H.img,{src:e,srcSet:s,alt:o,onLoad:u,referrerPolicy:y,crossOrigin:f??void 0,className:"chakra-avatar__img",loading:p,__css:{width:"100%",height:"100%",objectFit:"cover",borderRadius:l}})}Te.displayName="AvatarImage";var gt={display:"inline-flex",alignItems:"center",justifyContent:"center",textAlign:"center",textTransform:"uppercase",fontWeight:"medium",position:"relative",flexShrink:0},Pe=Ie((t,e)=>{const s=Ve("Avatar",t),[i,u]=C.useState(!1),{src:c,srcSet:o,name:l,showBorder:p,borderRadius:g="full",onError:v,onLoad:n,getInitials:y=mt,icon:f=a.jsx(Ae,{}),iconLabel:b=" avatar",loading:R,children:E,borderColor:O,ignoreFallback:A,crossOrigin:F,referrerPolicy:V,...K}=we(t),Y={borderRadius:g,borderWidth:p?"2px":void 0,...gt,...s.container};return O&&(Y.borderColor=O),a.jsx(H.span,{ref:e,...K,className:Le("chakra-avatar",t.className),"data-loaded":Ke(i),__css:Y,children:a.jsxs(dt,{value:s,children:[a.jsx(Te,{src:c,srcSet:o,loading:R,onLoad:Ze(n,()=>{u(!0)}),onError:v,getInitials:y,name:l,borderRadius:g,icon:f,iconLabel:b,ignoreFallback:A,crossOrigin:F,referrerPolicy:V}),E]})})});Pe.displayName="Avatar";var Qe=Ie(function(e,s){const{borderLeftWidth:i,borderBottomWidth:u,borderTopWidth:c,borderRightWidth:o,borderWidth:l,borderStyle:p,borderColor:g,...v}=qe("Divider",e),{className:n,orientation:y="horizontal",__css:f,...b}=we(e),R={vertical:{borderLeftWidth:i||o||l||"1px",height:"100%"},horizontal:{borderBottomWidth:u||c||l||"1px",width:"100%"}};return a.jsx(H.hr,{ref:s,"aria-orientation":y,...b,__css:{...v,border:"0",borderColor:g,borderStyle:p,...R[y],...f},className:Le("chakra-divider",n)})});Qe.displayName="Divider";var I,h,z,j,T,k,L,$,N,D,P,Q,_,M,d,W,ne,oe,le,ce,he,ue,de,ke,Oe,vt=(Oe=class extends Ge{constructor(e,s){super();S(this,d);S(this,I);S(this,h);S(this,z);S(this,j);S(this,T);S(this,k);S(this,L);S(this,$);S(this,N);S(this,D);S(this,P);S(this,Q);S(this,_);S(this,M,new Set);this.options=s,m(this,I,e),m(this,L,null),this.bindMethods(),this.setOptions(s)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(r(this,h).addObserver(this),Re(r(this,h),this.options)?x(this,d,W).call(this):this.updateResult(),x(this,d,ce).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return fe(r(this,h),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return fe(r(this,h),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,x(this,d,he).call(this),x(this,d,ue).call(this),r(this,h).removeObserver(this)}setOptions(e,s){const i=this.options,u=r(this,h);if(this.options=r(this,I).defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof U(this.options.enabled,r(this,h))!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");x(this,d,de).call(this),r(this,h).setOptions(this.options),i._defaulted&&!ae(this.options,i)&&r(this,I).getQueryCache().notify({type:"observerOptionsUpdated",query:r(this,h),observer:this});const c=this.hasListeners();c&&je(r(this,h),u,this.options,i)&&x(this,d,W).call(this),this.updateResult(s),c&&(r(this,h)!==u||U(this.options.enabled,r(this,h))!==U(i.enabled,r(this,h))||J(this.options.staleTime,r(this,h))!==J(i.staleTime,r(this,h)))&&x(this,d,ne).call(this);const o=x(this,d,oe).call(this);c&&(r(this,h)!==u||U(this.options.enabled,r(this,h))!==U(i.enabled,r(this,h))||o!==r(this,_))&&x(this,d,le).call(this,o)}getOptimisticResult(e){const s=r(this,I).getQueryCache().build(r(this,I),e),i=this.createResult(s,e);return xt(this,i)&&(m(this,j,i),m(this,k,this.options),m(this,T,r(this,h).state)),i}getCurrentResult(){return r(this,j)}trackResult(e,s){const i={};return Object.keys(e).forEach(u=>{Object.defineProperty(i,u,{configurable:!1,enumerable:!0,get:()=>(this.trackProp(u),s==null||s(u),e[u])})}),i}trackProp(e){r(this,M).add(e)}getCurrentQuery(){return r(this,h)}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const s=r(this,I).defaultQueryOptions(e),i=r(this,I).getQueryCache().build(r(this,I),s);return i.isFetchingOptimistic=!0,i.fetch().then(()=>this.createResult(i,s))}fetch(e){return x(this,d,W).call(this,{...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),r(this,j)))}createResult(e,s){var ve;const i=r(this,h),u=this.options,c=r(this,j),o=r(this,T),l=r(this,k),g=e!==i?e.state:r(this,z),{state:v}=e;let n={...v},y=!1,f;if(s._optimisticResults){const w=this.hasListeners(),ee=!w&&Re(e,s),Me=w&&je(e,i,s,u);(ee||Me)&&(n={...n,...et(v.data,e.options)}),s._optimisticResults==="isRestoring"&&(n.fetchStatus="idle")}let{error:b,errorUpdatedAt:R,status:E}=n;if(s.select&&n.data!==void 0)if(c&&n.data===(o==null?void 0:o.data)&&s.select===r(this,$))f=r(this,N);else try{m(this,$,s.select),f=s.select(n.data),f=Ce(c==null?void 0:c.data,f,s),m(this,N,f),m(this,L,null)}catch(w){m(this,L,w)}else f=n.data;if(s.placeholderData!==void 0&&f===void 0&&E==="pending"){let w;if(c!=null&&c.isPlaceholderData&&s.placeholderData===(l==null?void 0:l.placeholderData))w=c.data;else if(w=typeof s.placeholderData=="function"?s.placeholderData((ve=r(this,D))==null?void 0:ve.state.data,r(this,D)):s.placeholderData,s.select&&w!==void 0)try{w=s.select(w),m(this,L,null)}catch(ee){m(this,L,ee)}w!==void 0&&(E="success",f=Ce(c==null?void 0:c.data,w,s),y=!0)}r(this,L)&&(b=r(this,L),f=r(this,N),R=Date.now(),E="error");const O=n.fetchStatus==="fetching",A=E==="pending",F=E==="error",V=A&&O,K=f!==void 0;return{status:E,fetchStatus:n.fetchStatus,isPending:A,isSuccess:E==="success",isError:F,isInitialLoading:V,isLoading:V,data:f,dataUpdatedAt:n.dataUpdatedAt,error:b,errorUpdatedAt:R,failureCount:n.fetchFailureCount,failureReason:n.fetchFailureReason,errorUpdateCount:n.errorUpdateCount,isFetched:n.dataUpdateCount>0||n.errorUpdateCount>0,isFetchedAfterMount:n.dataUpdateCount>g.dataUpdateCount||n.errorUpdateCount>g.errorUpdateCount,isFetching:O,isRefetching:O&&!A,isLoadingError:F&&!K,isPaused:n.fetchStatus==="paused",isPlaceholderData:y,isRefetchError:F&&K,isStale:ge(e,s),refetch:this.refetch}}updateResult(e){const s=r(this,j),i=this.createResult(r(this,h),this.options);if(m(this,T,r(this,h).state),m(this,k,this.options),r(this,T).data!==void 0&&m(this,D,r(this,h)),ae(i,s))return;m(this,j,i);const u={},c=()=>{if(!s)return!0;const{notifyOnChangeProps:o}=this.options,l=typeof o=="function"?o():o;if(l==="all"||!l&&!r(this,M).size)return!0;const p=new Set(l??r(this,M));return this.options.throwOnError&&p.add("error"),Object.keys(r(this,j)).some(g=>{const v=g;return r(this,j)[v]!==s[v]&&p.has(v)})};(e==null?void 0:e.listeners)!==!1&&c()&&(u.listeners=!0),x(this,d,ke).call(this,{...u,...e})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&x(this,d,ce).call(this)}},I=new WeakMap,h=new WeakMap,z=new WeakMap,j=new WeakMap,T=new WeakMap,k=new WeakMap,L=new WeakMap,$=new WeakMap,N=new WeakMap,D=new WeakMap,P=new WeakMap,Q=new WeakMap,_=new WeakMap,M=new WeakMap,d=new WeakSet,W=function(e){x(this,d,de).call(this);let s=r(this,h).fetch(this.options,e);return e!=null&&e.throwOnError||(s=s.catch(Je)),s},ne=function(){x(this,d,he).call(this);const e=J(this.options.staleTime,r(this,h));if(xe||r(this,j).isStale||!ye(e))return;const i=Xe(r(this,j).dataUpdatedAt,e)+1;m(this,P,setTimeout(()=>{r(this,j).isStale||this.updateResult()},i))},oe=function(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(r(this,h)):this.options.refetchInterval)??!1},le=function(e){x(this,d,ue).call(this),m(this,_,e),!(xe||U(this.options.enabled,r(this,h))===!1||!ye(r(this,_))||r(this,_)===0)&&m(this,Q,setInterval(()=>{(this.options.refetchIntervalInBackground||Ye.isFocused())&&x(this,d,W).call(this)},r(this,_)))},ce=function(){x(this,d,ne).call(this),x(this,d,le).call(this,x(this,d,oe).call(this))},he=function(){r(this,P)&&(clearTimeout(r(this,P)),m(this,P,void 0))},ue=function(){r(this,Q)&&(clearInterval(r(this,Q)),m(this,Q,void 0))},de=function(){const e=r(this,I).getQueryCache().build(r(this,I),this.options);if(e===r(this,h))return;const s=r(this,h);m(this,h,e),m(this,z,e.state),this.hasListeners()&&(s==null||s.removeObserver(this),e.addObserver(this))},ke=function(e){Ue.batch(()=>{e.listeners&&this.listeners.forEach(s=>{s(r(this,j))}),r(this,I).getQueryCache().notify({query:r(this,h),type:"observerResultsUpdated"})})},Oe);function bt(t,e){return U(e.enabled,t)!==!1&&t.state.data===void 0&&!(t.state.status==="error"&&e.retryOnMount===!1)}function Re(t,e){return bt(t,e)||t.state.data!==void 0&&fe(t,e,e.refetchOnMount)}function fe(t,e,s){if(U(e.enabled,t)!==!1){const i=typeof s=="function"?s(t):s;return i==="always"||i!==!1&&ge(t,e)}return!1}function je(t,e,s,i){return(t!==e||U(i.enabled,t)===!1)&&(!s.suspense||t.state.status!=="error")&&ge(t,s)}function ge(t,e){return U(e.enabled,t)!==!1&&t.isStaleByTime(J(e.staleTime,t))}function xt(t,e){return!ae(t.getCurrentResult(),e)}var Ne=C.createContext(!1),yt=()=>C.useContext(Ne);Ne.Provider;function Ct(){let t=!1;return{clearReset:()=>{t=!1},reset:()=>{t=!0},isReset:()=>t}}var St=C.createContext(Ct()),Rt=()=>C.useContext(St),jt=(t,e)=>{(t.suspense||t.throwOnError)&&(e.isReset()||(t.retryOnMount=!1))},Et=t=>{C.useEffect(()=>{t.clearReset()},[t])},Ot=({result:t,errorResetBoundary:e,throwOnError:s,query:i})=>t.isError&&!e.isReset()&&!t.isFetching&&i&&rt(s,[t.error,i]),It=t=>{t.suspense&&typeof t.staleTime!="number"&&(t.staleTime=1e3)},wt=(t,e)=>(t==null?void 0:t.suspense)&&e.isPending,Lt=(t,e,s)=>e.fetchOptimistic(t).catch(()=>{s.clearReset()});function Ut(t,e,s){var g,v,n,y;const i=tt(),u=yt(),c=Rt(),o=i.defaultQueryOptions(t);(v=(g=i.getDefaultOptions().queries)==null?void 0:g._experimental_beforeQuery)==null||v.call(g,o),o._optimisticResults=u?"isRestoring":"optimistic",It(o),jt(o,c),Et(c);const[l]=C.useState(()=>new e(i,o)),p=l.getOptimisticResult(o);if(C.useSyncExternalStore(C.useCallback(f=>{const b=u?()=>{}:l.subscribe(Ue.batchCalls(f));return l.updateResult(),b},[l,u]),()=>l.getCurrentResult(),()=>l.getCurrentResult()),C.useEffect(()=>{l.setOptions(o,{listeners:!1})},[o,l]),wt(o,p))throw Lt(o,l,c);if(Ot({result:p,errorResetBoundary:c,throwOnError:o.throwOnError,query:i.getQueryCache().get(o.queryHash)}))throw p.error;return(y=(n=i.getDefaultOptions().queries)==null?void 0:n._experimental_afterQuery)==null||y.call(n,o,p),o.notifyOnChangeProps?p:l.trackResult(p)}function Ft(t,e){return Ut(t,vt)}const _t=async()=>{await Fe(500);const t=X.getState().user;if(!(t!=null&&t.id))throw new Error("ユーザーが認証されていません");return Promise.resolve({...t})},At=async t=>{await Fe(500);const e=X.getState().user;if(!e)throw new Error("ユーザーが認証されていません");const s={...e,...t,avatar:t.avatar?URL.createObjectURL(t.avatar):e.avatar};return Promise.resolve(s)},De=()=>{const{updateTrigger:t}=X();return Ft({queryKey:["/api/user/me",t],queryFn:_t})},Tt=()=>{const{data:t,error:e,isError:s,isLoading:i}=De();return i?a.jsx(B,{}):s?a.jsx(Z,{color:"red.500",children:e.message}):t?a.jsx(me,{children:a.jsxs(pe,{spacing:4,align:"center",children:[a.jsx(Pe,{size:"2xl",name:t.username,src:t.avatar||void 0}),a.jsx(Z,{fontSize:"2xl",fontWeight:"bold",children:t.username}),a.jsx(Z,{children:t.email}),a.jsx(Z,{children:t.bio})]})}):null},Pt=()=>it({mutationFn:async t=>await At(t)}),Ee=500,Qt=2*1024*1024,kt=at().shape({username:se().required("ユーザー名が必須です"),email:se().email("無効なメールアドレスです").required("Eメールは必須です"),bio:se().max(Ee,`経歴は${Ee}文字以内で入力してください`).optional(),avatar:nt().test("fileSize","ファイルが大きすぎます",t=>t&&t instanceof File?t.size<=Qt:!0).optional()}),Nt=()=>{var f,b,R;const{data:t,isLoading:e}=De(),s=Pt(),{register:i,handleSubmit:u,reset:c,control:o,formState:{errors:l,isSubmitting:p}}=lt({resolver:ot(kt)}),{setUser:g,triggerUpdate:v}=X(),n=ut();C.useEffect(()=>{t&&c(t)},[t,c]);const y=async E=>{try{const O=await s.mutateAsync({...E});g(O),v(),n({title:"プロフィールが更新されました。",status:"success",duration:3e3,isClosable:!0})}catch(O){n({title:"更新に失敗しました。",description:O.message,status:"error",duration:3e3,isClosable:!0})}};return a.jsx(me,{as:"form",onSubmit:u(y),children:a.jsxs(pe,{spacing:4,children:[a.jsxs(q,{isInvalid:!!l.username,children:[a.jsx(G,{children:"Username"}),e?a.jsx(B,{}):a.jsx(ie,{...i("username")}),a.jsx(re,{children:(f=l.username)==null?void 0:f.message})]}),a.jsxs(q,{isInvalid:!!l.email,children:[a.jsx(G,{children:"Email"}),e?a.jsx(B,{}):a.jsx(ie,{...i("email")}),a.jsx(re,{children:(b=l.email)==null?void 0:b.message})]}),a.jsxs(q,{isInvalid:!!l.bio,children:[a.jsx(G,{children:"Bio"}),e?a.jsx(B,{}):a.jsx(ht,{...i("bio")}),a.jsx(re,{children:(R=l.bio)==null?void 0:R.message})]}),a.jsxs(q,{children:[a.jsx(G,{children:"Avatar"}),a.jsx(ct,{name:"avatar",control:o,render:({field:E})=>e?a.jsx(B,{}):a.jsx(ie,{type:"file",accept:"image/*",onChange:O=>{var F;const A=(F=O.target.files)==null?void 0:F[0];E.onChange(A)},onClick:O=>{O.target.value=""}})})]}),a.jsx(st,{type:"submit",colorScheme:"blue",isLoading:p||e,children:"Update Profile"})]})})},Vt=()=>a.jsx(me,{maxWidth:"600px",margin:"auto",padding:8,children:a.jsxs(pe,{spacing:8,align:"stretch",children:[a.jsx(Se,{as:"h1",size:"xl",textAlign:"center",children:"User Profile"}),a.jsx(Tt,{}),a.jsx(Qe,{}),a.jsx(Se,{as:"h2",size:"lg",children:"Edit Profile"}),a.jsx(Nt,{})]})});export{Vt as default};
